version: '3.8'

services:
  piston:
    image: ghcr.io/engineer-man/piston
    container_name: piston_production
    ports:
      - "127.0.0.1:2000:2000"  # Only bind to localhost
    environment:
      - PISTON_LOG_LEVEL=WARN
      - PISTON_ENABLE_NETWORKING=false
      - PISTON_MAX_PROCESS_COUNT=32
      - PISTON_MAX_OPEN_FILES=1024
      - PISTON_MAX_FILE_SIZE=5000000
      - PISTON_COMPILE_TIMEOUT=10000
      - PISTON_RUN_TIMEOUT=3000
    volumes:
      - piston_packages:/piston/packages
    restart: always
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    ulimits:
      nproc: 512
      nofile: 1024
    mem_limit: 1g
    cpus: 0.5
    read_only: true
    networks:
      - piston_network

networks:
  piston_network:
    driver: bridge
    internal: true

volumes:
  piston_packages: